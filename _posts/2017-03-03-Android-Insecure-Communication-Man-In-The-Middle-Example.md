---
published: false
---
I chose one application in Google Play to test. Its main functionalities were focused on consuming a RESTful web service. I decompiled this application using tools dex2jar and JD-GUI. Firstly I connected my phone to computer to get apk file

	$ adb pull /data/app/com.example.app.apk

Then I converted apk into jar and ran decompiler

	$ ./d2j-dex2jar.sh com.example.app.apk -o app.jar
	dex2jar com.example.app.apk -> app.jar

	$ java -jar jd-gui-1.4.0.jar app.jar

During code analysis I found some interesting piece which made me think that application doesn't verify SSL certificate.

	SSLContext sc = SSLContext.getInstance("TLS");
	sc.init(null, new TrustManager[] { new TrustAllX509TrustManager() }, new java.security.SecureRandom());
	HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());
	HttpsURLConnection.setDefaultHostnameVerifier( new HostnameVerifier(){
    	public boolean verify(String string,SSLSession ssls) {
        	return true;
    	}
	});
	
	public class TrustAllX509TrustManager implements X509TrustManager {
    	public X509Certificate[] getAcceptedIssuers() {
        	return new X509Certificate[0];
    	}
	
    	public void checkClientTrusted(java.security.cert.X509Certificate[] certs,
        	    String authType) {
    	}
	
    	public void checkServerTrusted(java.security.cert.X509Certificate[] certs,
        	    String authType) {
    	}
	}
    
To prove it I ran Burp Suite and set up proxy on my phone. It was important to not install Burp's CA certificate. Web browser started to show warning when I was trying to load any page through HTTPS, but my application was connecing to web service without any problems.
I decided to exploit this vulnerability and peform Man-in-the-middle attack by setting up proxy between target's mobile device and web service.

I started with proxy which was script written in PHP and ran on Apache. It passes requests to legitimate web service and returns response from it slightly modifying headers to make whole communication readable. Apache required rewriting rule to redirect every URL to this script and self-signed SSL certificate.

	<VirtualHost *:443>
		ServerName evil.com
		RewriteEngine on
		RewriteCond %{REQUEST_FILENAME} !-d
		RewriteCond %{REQUEST_FILENAME} !-f
		RewriteRule . /proxy.php [L]
		DocumentRoot /var/www/html
		SSLEngine on
		SSLCertificateFile "/tmp/server.cert"
		SSLCertificateKeyFile "/tmp/server.key"
	</VirtualHost>

Certificate was generated by command

	$ openssl req -nodes -new -x509 -keyout server.key -out server.cert
    
